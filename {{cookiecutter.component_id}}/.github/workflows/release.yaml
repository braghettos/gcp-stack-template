name: Release Charts

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Create ArgoCD application
        run: |
          curl -v -k --fail --location \
          --request POST 'https://argocd.projectx.kiratech.biz/api/v1/applications' \
          --header 'Content-Type: application/json' \
          --header 'Cookie: argocd.token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiYjRiYmRmOS01NDNmLTQ3ODAtYTE1My1mMDY5NDRhZjkyOTQiLCJpYXQiOjE2MTMwNTg0NzcsImlzcyI6ImFyZ29jZCIsIm5iZiI6MTYxMzA1ODQ3Nywic3ViIjoiYmFja3N0YWdlIn0.CJIim9lrc172eSV_Wf4LGqvoh1ODG37Nsbs3mXt7XGk' \
          --data-raw '{
              "metadata": {
                  "name": "{{cookiecutter.component_id}}"
              },
              "spec": {
                  "source": {
                      "repoURL": "{{cookiecutter.storePath}}",
                      "path": "charts/"
                  },
                  "destination": {
                      "namespace": "{{cookiecutter.component_id}}",
                      "server": "https://lokomotive.projectx.kiratech.biz:6443"
                  },
                  "syncPolicy": {
                      "syncOptions": [
                          "CreateNamespace=true"
                      ],
                      "automated": {
                          "allowEmpty": true,
                          "prune": false,
                          "selfHeal": false
                      }
                  }
              }
          }'
