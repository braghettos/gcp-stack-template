name: Release Charts

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Create ArgoCD application
        run: |
          curl -v -k --location \
          --request POST 'https://argocd.projectx.kiratech.biz/api/v1/applications' \
          --header 'Content-Type: application/json' \
          --header 'Cookie: argocd.token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE2MTEzMTQyNTUuMzg5NjYyLCJpc3MiOiJhcmdvY2QiLCJuYmYiOjE2MTEzMTQyNTUuMzg5NjYyLCJzdWIiOiJhZG1pbiJ9.KtqJnn7ZvOdqX9BnD-pN2CXm4M63HC-rGw8lf57sqNs' \
          --data-raw '{
              "metadata": {
                  "name": "{{cookiecutter.component_id}}"
              },
              "spec": {
                  "source": {
                      "repoURL": "{{cookiecutter.storePath}}",
                      "path": "charts/"
                  },
                  "destination": {
                      "namespace": "{{cookiecutter.component_id}}",
                      "server": "https://lokomotive-cluster.projectx.kiratech.biz:6443"
                  },
                  "syncPolicy": {
                      "syncOptions": [
                          "CreateNamespace=true"
                      ],
                      "automated": {
                          "prune": true,
                          "selfHeal": true
                      }
                  }
              }
          }'
