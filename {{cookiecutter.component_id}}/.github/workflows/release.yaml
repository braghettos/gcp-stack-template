name: Release Charts

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Create ArgoCD application
        run: |
          curl -v -k --fail --location \
          --request POST 'https://argocd.projectx.kiratech.biz/api/v1/applications' \
          --header 'Content-Type: application/json' \
          --header 'Cookie: argocd.token=yJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0ZDY0M2YyOC0yYTIyLTQzZDQtYjZlNy05MmU2OTE2ODJhYTQiLCJpYXQiOjE2MTIzNTAxNDIsImlzcyI6ImFyZ29jZCIsIm5iZiI6MTYxMjM1MDE0Miwic3ViIjoiYmFja3N0YWdlIn0.WCBd6ENUz0ubOQES4urJ5I1UeV3FAPn9Alo3lflHZww' \
          --data-raw '{
              "metadata": {
                  "name": "{{cookiecutter.component_id}}"
              },
              "spec": {
                  "source": {
                      "repoURL": "{{cookiecutter.storePath}}",
                      "path": "charts/"
                  },
                  "destination": {
                      "namespace": "{{cookiecutter.component_id}}",
                      "server": "https://lokomotive-cluster.projectx.kiratech.biz:6443"
                  },
                  "syncPolicy": {
                      "syncOptions": [
                          "CreateNamespace=true"
                      ],
                      "automated": {
                          "prune": true,
                          "selfHeal": true
                      }
                  }
              }
          }'
